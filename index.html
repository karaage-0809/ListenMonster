<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ListenMonsters</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #b2ebf2); /* ç™½ã¨æ°´è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
      color: #333; /* ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã« */
      padding: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      min-height: 100vh;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
      color: #0d47a1; /* ã‚¿ã‚¤ãƒˆãƒ«è‰²ã‚’æ¿ƒã„é’ã« */
    }

    button {
      font-size: 1.2rem;
      padding: 15px 30px;
      margin: 15px 0;
      border-radius: 30px;
      border: none;
      background: linear-gradient(to right, #64b5f6, #1e88e5); /* é’è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
      color: #fff;
      cursor: pointer;
      box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
      display: inline-block; /* ãƒœã‚¿ãƒ³ãŒä¸­å¤®å¯„ã›ã®å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã« */
      position: relative; /* ã‚­ãƒ©ãƒƒã¨å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«å¿…è¦ */
      overflow: hidden; /* ã‚­ãƒ©ãƒƒã¨å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒœã‚¿ãƒ³ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
      z-index: 1; /* å…‰ãŒãƒœã‚¿ãƒ³ã®ä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« */
    }

    button:disabled {
      background: #90caf9; /* è–„ã„é’è‰² */
      cursor: not-allowed;
      box-shadow: none;
      animation: none; /* ç„¡åŠ¹æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ */
    }

    /* æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ï¼šãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .button-container {
        text-align: center;
        margin-bottom: 20px; /* å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ */
    }


    .section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.7); /* ç™½è‰²ã®åŠé€æ˜èƒŒæ™¯ */
      border-radius: 20px;
      box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
      width: 90%;
      max-width: 600px;
      text-align: center; /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚‚ä¸­å¤®å¯„ã›ã«ã™ã‚‹å ´åˆ */
    }

    .character {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px auto; /* å·¦å³ãƒãƒ¼ã‚¸ãƒ³ã‚’autoã«ã—ã¦ä¸­å¤®å¯„ã› */
      /* backgroundã¯rarity-specific classã§å®šç¾© */
      border: 1px solid #b0bec5; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®æ ç·š */
      border-radius: 20px;
      font-size: 1.1rem;
      text-align: left; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å·¦å¯„ã›ã«æˆ»ã™ */
      max-width: 90%; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¦ç´ ã®æœ€å¤§å¹… */
      position: relative; /* ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«è¿½åŠ  */
      overflow: hidden; /* ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
    }

    .character img {
      width: 70px;
      height: 70px;
      margin-right: 15px;
      border-radius: 50%;
      border: 2px solid #fff;
      object-fit: cover;
      z-index: 2; /* ç”»åƒãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« */
      position: relative; /* z-indexã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ */
    }

    .rare1 { background: rgba(179, 229, 252, 0.7); } /* è–„ã„æ°´è‰² */
    .rare2 { background: rgba(129, 212, 250, 0.7); } /* å°‘ã—æ¿ƒã„æ°´è‰² */
    /* rare3 (æ˜Ÿ3) ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é‡‘è‰²ã¨ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«è¨­å®š */
    .rare3 {
      background: linear-gradient(135deg, #FFD700, #FFC107, #FFD700); /* é‡‘è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      font-weight: bold;
      border: 2px solid #FFD700; /* é‡‘è‰²ã®æ ç·š */
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); /* é‡‘è‰²ã®å…‰å½© */
    }

    /* rare3ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .rare3::before,
    .rare3::after { /* ::afterã‚‚è¿½åŠ  */
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.7) 10%, rgba(255, 255, 255, 0) 70%); /* é€æ˜åº¦ã‚’ä¸Šã’ã¦ã‚ˆã‚Šæ˜ã‚‹ã */
      opacity: 0;
      transform: scale(0);
      animation: sparkle-more 3s infinite ease-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’é•·ãã—ã¦ã€å‹•ãã‚’æ»‘ã‚‰ã‹ã« */
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¦¨ã’ãªã„ã‚ˆã†ã« */
      z-index: 1; /* èƒŒæ™¯ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“ã«è¡¨ç¤º */
    }

    .rare3::after {
      animation-delay: 1.5s; /* ::beforeã¨ãšã‚‰ã—ã¦ã€å¸¸ã«ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ã›ã‚‹ */
      animation-duration: 3.5s; /* å°‘ã—ç•°ãªã‚‹é€Ÿåº¦ */
      background: radial-gradient(circle, rgba(255, 255, 255, 0.6) 15%, rgba(255, 255, 255, 0) 75%); /* å°‘ã—ç•°ãªã‚‹å…‰ã‚Šæ–¹ */
    }

    @keyframes sparkle-more {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }
      20% {
        transform: scale(0.8) rotate(72deg); /* ã‚ˆã‚Šå¤§ãã */
        opacity: 0.8; /* ã‚ˆã‚Šæ˜ã‚‹ã */
      }
      40% {
        transform: scale(0.6) rotate(144deg); /* ä¸€åº¦ç¸®ã‚“ã§å†åº¦åºƒãŒã‚‹å‹•ã */
        opacity: 0.6;
      }
      60% {
        transform: scale(1.0) rotate(216deg); /* å†åº¦å¤§ãã */
        opacity: 0.9;
      }
      80% {
        transform: scale(0.7) rotate(288deg); /* æœ€å¾Œã«ã‚‚ã†ä¸€åº¦ç¸®ã‚€ */
        opacity: 0.5;
      }
      100% {
        transform: scale(0) rotate(360deg);
        opacity: 0;
      }
    }


    #result {
      margin: 20px 0;
      font-size: 1.4rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
      min-height: 80px;
    }

    #result img {
      max-width: 120px;
      max-height: 120px;
      margin-bottom: 10px;
      border-radius: 15px;
      border: 3px solid #03a9f4; /* æ°´è‰²ã®æ ç·š */
      box-shadow: 0 0 10px rgba(3, 169, 244, 0.5); /* æ°´è‰²ã®å…‰ */
    }

    #user-info {
      margin-bottom: 15px;
      font-weight: bold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
      color: #1565c0; /* æ¿ƒã„é’è‰² */
    }

    #transcript {
      font-size: 1.1rem;
      margin-top: 10px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
    }

    #kanaCount, #points {
      font-size: 1.1rem;
      margin-top: 5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* å½±ã‚’å¼±ã‚ã« */
    }

    #collection {
      text-align: center; /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ä¸­å¤®å¯„ã› */
    }

    /* ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ã®ã‚­ãƒ©ãƒƒã¨å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    #gachaBtn.shine-animation::before {
      content: '';
      position: absolute;
      top: 0;
      left: -75%; /* é–‹å§‹ä½ç½®ã‚’å·¦å¤–ã« */
      width: 50%; /* å…‰ã®å¹… */
      height: 100%;
      background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 100%);
      transform: skewX(-20deg); /* æ–œã‚ã«ã™ã‚‹ */
      animation: shine 1.5s infinite linear; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š */
    }

    @keyframes shine {
      0% {
        left: -75%;
      }
      100% {
        left: 100%; /* çµ‚äº†ä½ç½®ã‚’å³å¤–ã« */
      }
    }


    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }

      button {
        font-size: 1rem;
        padding: 10px 20px;
      }

      .section {
        margin: 20px 0;
        padding: 15px;
      }

      .character {
        font-size: 1rem;
        margin: 10px auto; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚ä¸­å¤®å¯„ã› */
      }

      .character img {
        width: 50px;
        height: 50px;
      }

      #result {
        font-size: 1.2rem;
      }

      #result img {
        max-width: 80px;
        max-height: 80px;
      }
    }
  </style>
</head>
<body>

  <h1>ListenMonsters</h1>

  <div id="user-info">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</div>
  <div class="button-container">
    <button id="btn-login">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btn-logout" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div class="section">
    <div class="button-container">
      <button id="startBtn" disabled>ğŸ™ï¸ éŸ³å£°å…¥åŠ›ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
    <div id="transcript">ğŸ§ è©±ã—ãŸå†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div id="kanaCount">ğŸ”¢ ã‚«ã‚¦ãƒ³ãƒˆï¼š</div>
    <div id="points">ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆï¼š0</div>
  </div>

  <div class="section">
    <div class="button-container">
      <button id="gachaBtn" disabled>ğŸ ã‚¬ãƒãƒ£ã‚’å¼•ãï¼ˆ10ptï¼‰</button>
    </div>
    <div id="result"></div>
  </div>

  <div class="section">
    <h2>ğŸ“š ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
    <div id="collection">ã¾ã ã‚­ãƒ£ãƒ©ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Firebaseè¨­å®šï¼ˆã“ã“ã‚’è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«å¤‰ãˆã¦ãã ã•ã„ï¼‰
      const firebaseConfig = {
        
      };

      // Firebase åˆæœŸåŒ–
      const app = window.firebase.initializeApp(firebaseConfig);
      const db = window.firebase.firestore(app);
      const auth = window.firebase.auth(app);
      const provider = new window.firebase.auth.GoogleAuthProvider();

      // DOMè¦ç´ 
      const userInfoDiv = document.getElementById("user-info");
      const btnLogin = document.getElementById("btn-login");
      const btnLogout = document.getElementById("btn-logout");
      const startBtn = document.getElementById("startBtn");
      const transcriptDiv = document.getElementById("transcript");
      const kanaCountDiv = document.getElementById("kanaCount");
      const pointsDiv = document.getElementById("points");
      const gachaBtn = document.getElementById("gachaBtn");
      const resultDiv = document.getElementById("result");
      const collectionDiv = document.getElementById("collection");

      // éŸ³å£°èªè­˜æº–å‚™
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.continuous = false;

      // å¤‰æ•°
      let currentUser = null;
      let points = 0;
      let collection = [];

      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
      const characters = [
        { name: "ã­ã“å‹‡è€…", rarity: "â˜…", class: "rare1", weight: 60, image: "images/neko_yuusha.png" },
        { name: "ãƒãƒ¼ã‚ºç‹å­", rarity: "â˜…â˜…", class: "rare2", weight: 30, image: "images/cheese_ouji.png" },
        { name: "ãƒ¬ã‚¢ã†ã•ã", rarity: "â˜…â˜…â˜…", class: "rare3", weight: 10, image: "images/rare_usagi.png" },
        { name: "ã´ã‚ˆè³¢è€…", rarity: "â˜…", class: "rare1", weight: 50, image: "images/piyo_kenja.png" },
        { name: "ã‚Šã™é­”å°å£«", rarity: "â˜…â˜…", class: "rare2", weight: 20, image: "images/risu_madoushi.png" },
      ];

      const totalWeight = characters.reduce((sum, char) => sum + char.weight, 0);

      // èªè¨¼çŠ¶æ…‹ç›£è¦–
      window.firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          userInfoDiv.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName}`;
          btnLogin.style.display = "none";
          btnLogout.style.display = "inline-block";
          startBtn.disabled = false;
          await loadUserData();
          gachaBtn.disabled = points < 10;
          // ã“ã“ã§ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ã®åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’è¨­å®š
          updateGachaButtonAnimation();
        } else {
          currentUser = null;
          userInfoDiv.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“";
          btnLogin.style.display = "inline-block";
          btnLogout.style.display = "none";
          startBtn.disabled = true;
          gachaBtn.disabled = true;
          points = 0;
          pointsDiv.textContent = `ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆï¼š${points}`;
          collection = [];
          updateCollection();
          transcriptDiv.textContent = "ğŸ§ è©±ã—ãŸå†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
          kanaCountDiv.textContent = "ğŸ”¢ ã‚«ã‚¦ãƒ³ãƒˆï¼š";
          resultDiv.textContent = "";
          updateGachaButtonAnimation(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
        }
      });

      // ãƒ­ã‚°ã‚¤ãƒ³
      btnLogin.addEventListener("click", async () => {
        try {
          await window.firebase.auth().signInWithPopup(provider);
        } catch (e) {
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
        }
      });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      btnLogout.addEventListener("click", () => {
        window.firebase.auth().signOut();
      });

      // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      async function loadUserData() {
        if (!currentUser) return;
        const userDocRef = db.collection("users").doc(currentUser.uid);
        const docSnap = await userDocRef.get();

        if (docSnap.exists) {
          const userData = docSnap.data();
          points = userData.points || 0;
          // Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã«ç”»åƒãƒ‘ã‚¹ãŒãªã‘ã‚Œã°è¿½åŠ ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
          collection = userData.characters ? userData.characters.map(item => {
            const charData = characters.find(char => char.name === item.name);
            return charData ? { ...item, image: charData.image } : item;
          }) : [];
        } else {
          points = 0;
          collection = [];
          await userDocRef.set({ points: 0, characters: [] });
        }
        pointsDiv.textContent = `ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆï¼š${points}`;
        updateCollection();
      }

      // Firestoreã«ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
      async function savePoints(newPoints) {
        if (!currentUser) return;
        const userDocRef = db.collection("users").doc(currentUser.uid);
        try {
          await userDocRef.update({ points: newPoints });
          points = newPoints;
          pointsDiv.textContent = `ğŸ’° ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆï¼š${points}`;
          // ãƒã‚¤ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
          gachaBtn.disabled = points < 10;
          updateGachaButtonAnimation();
        } catch (e) {
          console.error("ãƒã‚¤ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
          alert("ãƒã‚¤ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      // Firestoreã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
      async function saveCollection(newChar) {
        if (!currentUser) return;
        const userDocRef = db.collection("users").doc(currentUser.uid);
        try {
            // Firestoreã«ä¿å­˜ã™ã‚‹éš›ã¯ã€ç”»åƒãƒ‘ã‚¹ã¯å«ã‚ãªã„ï¼ˆã¾ãŸã¯å«ã‚ã¦ã‚‚è‰¯ã„ãŒã€ä»Šå›ã¯åå‰ã¨ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ã¿ã«ã™ã‚‹ï¼‰
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ãŸã‚
            await userDocRef.update({
                characters: window.firebase.firestore.FieldValue.arrayUnion({
                    name: newChar.name,
                    rarity: newChar.rarity,
                    class: newChar.class // classã‚‚ä¿å­˜ã—ã¦ãŠã
                })
            });
            // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ç”»åƒãƒ‘ã‚¹ã‚’å«ã‚€å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            collection.push(newChar);
            updateCollection();
        } catch (e) {
            console.error("ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            alert("ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      // ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
      function updateGachaButtonAnimation() {
        if (!gachaBtn.disabled) {
          gachaBtn.classList.add('shine-animation');
        } else {
          gachaBtn.classList.remove('shine-animation');
        }
      }

      // éŸ³å£°èªè­˜é–‹å§‹ãƒœã‚¿ãƒ³
      startBtn.onclick = () => {
        resultDiv.textContent = "";
        recognition.start();
      };

      // éŸ³å£°èªè­˜çµæœå–å¾—
      recognition.onresult = async (event) => {
        const recognizedText = event.results[0][0].transcript;
        transcriptDiv.textContent = "ğŸ“„ æ–‡å­—èµ·ã“ã—ï¼š" + recognizedText;

        const kanaCounts = {};
        for (let ch of recognizedText) {
          kanaCounts[ch] = (kanaCounts[ch] || 0) + 1;
        }

        const display = Object.entries(kanaCounts)
          .filter(([_, count]) => count > 0)
          .map(([char, count]) => `${char}: ${count}`)
          .join(" / ");
        kanaCountDiv.textContent = "ğŸ”¤ ã‚«ã‚¦ãƒ³ãƒˆ: " + display;

        const addedPoints = Object.values(kanaCounts).reduce((a, b) => a + b, 0);
        
        await savePoints(points + addedPoints); // ãƒã‚¤ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ã¨updateGachaButtonAnimationãŒå‘¼ã°ã‚Œã‚‹
      };

      // ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
      gachaBtn.onclick = async () => {
        if (points < 10) {
          alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
          return;
        }
        
        await savePoints(points - 10); // ãƒã‚¤ãƒ³ãƒˆãŒæ¸›ã‚‹ã¨updateGachaButtonAnimationãŒå‘¼ã°ã‚Œã‚‹
        const rand = Math.random() * totalWeight;
        let cumulativeWeight = 0;
        let resultChar = null;

        for (const char of characters) {
            cumulativeWeight += char.weight;
            if (rand < cumulativeWeight) {
                resultChar = char;
                break;
            }
        }
        if (!resultChar) {
            resultChar = characters[0]; // ä¸‡ãŒä¸€è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        }

        // â˜…ã‚¬ãƒãƒ£çµæœã«ã‚‚ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´â˜…
        resultDiv.innerHTML = `
            <img src="${resultChar.image}" alt="${resultChar.name}">
            <br>
            ğŸ‰ <strong>${resultChar.name}</strong>ï¼ˆ${resultChar.rarity}ï¼‰ã‚’ã‚²ãƒƒãƒˆï¼
        `;
        
        // saveCollectioné–¢æ•°ã«å®Œå…¨ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
        await saveCollection(resultChar); 
      };

      // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ›´æ–°
      function updateCollection() {
        if (collection.length === 0) {
          collectionDiv.textContent = "ã¾ã ã‚­ãƒ£ãƒ©ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚";
          return;
        }
        // â˜…ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã«ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸâ˜…
        collectionDiv.innerHTML = collection.map(c =>
          `<div class="character ${c.class}">
             <img src="${c.image}" alt="${c.name}">
             <span>${c.name}ï¼ˆ${c.rarity}ï¼‰</span>
           </div>`
        ).join("");
      }
    });
  </script>

</body>
</html>